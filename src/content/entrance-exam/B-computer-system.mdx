---
title: 計算機システムまとめ
created: 2025-07-31
tags:
- computer-system
- guide
---

# 記憶階層全般

## 時間的局所性

ある項目が参照された場合、その項目がまもなく再び参照される可能性が高い。

## 空間的局所性

ある項目が参照された場合、その項目の近くにある項目がまもなく再び参照される可能性が高い。

## ミス・ペナルティ

記憶回想のあるレベルでキャッシュミスしたときに、下位のレベルからブロックを取り出すのにかかる時間。

# キャッシュ

ダイレクトマップ方式を考えている。ダイレクトマップ方式とは、メモリ中の語のアドレスに基づいて、それをキャッシュに入れる位置を一意に割り当てるもの。

```txt
(Block address) modulo (Number of blocks in cache)
```

これによりキャッシュのどの行に入れるかが定まる。

## ライトスルーキャッシュ

データを書き込む際にキャッシュと記憶階層の次の下位レベルの両方を常に更新する方式。両者の間でデータが一貫していることがつねに保証される。
プロセッサの速度がかなり低下する可能性がある。

## ライト・バッファ

主記憶への書き込み待ちのデータを保持する待ち行列を持つ方式。主記憶の書き込み完了の速度が、プロセッサで生じる主記憶書き込みの発生頻度よりも低ければ、意味がない。

## ライトバックキャッシュ

データを書き込む際はキャッシュ中のブロックを更新するだけにとどめ、ブロックを置き換えるときに更新された内容を記憶階層の下位レベルに書き戻す方式。
キャッシュを介してメモリアクセスを行うとき、storeはまずキャッシュにする（Dirty化）。Dirtyな行の中身を追い出すときに、すでにstoreされているデータを主記憶に逃がす。
ロード時にキャッシュの番地にデータがなかったり、期待するデータではなかった場合はキャッシュミスとなり、メモリアクセスが生じる。
速いが、実装が複雑。

## ヒットとミスの判定

タグとインデックス（セット）を見る。インデックスとタグが一致していればヒット。タグが一致していなければミス。

## load/store の対応

loadでヒットしたときはなにもしない。
loadでミスしたときは、ライトバックでdirty bitが1なら書き戻しが起きて、0のときは起きない。その後、主記憶から該当ブロックがロードされて置き換わる。

storeでヒットしたときはキャッシュの該当する語が書き換わる。dirty bitが0なら1になる。
storeでミスしたときは、dirty bitが0ならブロックが置き換わって、該当する語が書き換わる。1なら書き戻しが起こる。

dirty bitは、ブロックが主記憶との差分があるかを管理する。差分がある（1）場合、置換対象であれば書き戻しが起こる。

## 書き込み時の対応

ライト・スルー方式のキャッシュでミスが起きたときを考える。

### ライト・アロケート

キャッシュ内にブロックを割り当てる。最も一般的。メモリからブロックが取り出され、そのブロックの適切な部分が上書きされる。

### ノー・ライト・アロケート

メモリ中のブロックの該当部分が更新されるが、そのブロックはキャッシュには収められない。
OSがメモリ中のページをゼロクリアするときなど、キャッシュにデータを入れる必要がないときがあるため。

## マルチレベル・キャッシュ

キャッシュを1レベル追加して、DRAMアクセス時間（遅）とプロセッサのクロック周波数（速）の差を縮める。
1次キャッシュでミスが起これば、2次キャッシュを参照する。ここにデータがあれば、ミスペナルティは小さく済む。
単一のキャッシュを使用する場合と比べ、1次キャッシュではブロックサイズが小さく、2次キャッシュは大きい。ともにミスペナルティを減らすためである。

## ブロックサイズとミス率の関係

ブロックサイズが大きいと、空間局所性を活用してミス率を下げられる。また、データを相対的に効率よく転送できる。
逆にブロックサイズが大きすぎると、キャッシュ中に保持できるブロック数が少なくなり、ブロック間の競合が生じてミス率が上がる。
また、ブロックの転送時間が増大しミス・ペナルティが大きくなる。グラフにすると、下に浅い凸の形になる。

## 可用性 Availability

MTTF: 平均故障寿命 mean time to failure<br />
MTTR: 平均修復時間 mean time to repair <br />
とおくと、

$$
\text{可用性} = \frac{\text{MTTF}}{\text{MTTF}+\text{MTTR}}
$$

# 仮想記憶

主記憶を2次記憶（磁気ディスクなど）にとっての「キャッシュ」のように使用する技法。

## ページ・テーブル

仮想記憶システムにおいて、仮想アドレスと物理アドレスの対応情報を保持した表。主記憶に格納されていて、仮想ページ番号でインデックス付けされる。
仮想ページが主記憶に読み込まれていたら、表の該当項目にその物理ページ番号が記録される。

## ページ・フォールト

アクセスしたページが主記憶上に存在しないときに発生する。仮想記憶と2次記憶の間でのキャッシュミスに相当するもの。仮想記憶ではブロックを「ページ」という。

## TLB translation-lookaside buffer

ページ・テーブルにアクセスしないで済むように、最近使用されたアドレスの対応関係を記録しているキャッシュ（局所性の利用）。
これがないと、メモリアクセスで手間がかかる（ページテーブルで物理アドレスを取得した後に、実際のデータを取得しにいく）。
ページテーブルにとってのキャッシュとなる。
